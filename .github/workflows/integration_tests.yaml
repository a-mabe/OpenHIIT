name: Build and Run Integration Tests

run-name: ${{ github.actor }} is building and testing OpenHIIT

on:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    branches: [main, pre-release]
    paths:
      - 'lib/**'
      - 'test_driver/**'
      - 'integration_test/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - 'android/**'
      - 'ios/**'

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Flutter pub
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Build debug APK (once)
        run: flutter build apk --debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: build/app/outputs/flutter-apk/app-debug.apk

  run-tests:
    name: Run Integration Tests
    needs: build-apk
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        test_file:
          - simple_test.dart
          - advanced_test.dart
          - restart_rounds_test.dart
          - load_test.dart
          - interval_adjust_test.dart
          - edit_timer_test.dart
          - customize_test.dart
          - minutes_view_test.dart

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: app-debug-apk
          path: build/app/outputs/flutter-apk

      - name: Flutter pub get
        run: flutter pub get

      - name: Create test script
        run: |
          cat <<EOF > scripts/test.sh
          #!/bin/bash
          set -e
          echo "Running test: ${{ matrix.test_file }}"

          bash scripts/wait_for_pm.sh

          adb -s emulator-5554 install -r build/app/outputs/flutter-apk/app-debug.apk
          adb -s emulator-5554 shell appops set com.codepup.workout_timer SCHEDULE_EXACT_ALARM allow

          flutter drive -d emulator-5554 --no-pub \
            --driver=integration_test/driver.dart \
            --target=integration_test/${{ matrix.test_file }} \
            --use-application-binary=build/app/outputs/flutter-apk/app-debug.apk
          EOF

          chmod +x scripts/test.sh

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run integration tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 36
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: scripts/test.sh

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.test_file }}
          path: screenshots/


# name: Build and Run Integration Tests

# run-name: ${{ github.actor }} is building and testing OpenHIIT

# on:
#   workflow_dispatch:
#   pull_request:
#     types: [opened, reopened, synchronize, ready_for_review]
#     branches: [main, pre-release]
#     paths:
#       - 'lib/**'
#       - 'test_driver/**'
#       - 'integration_test/**'
#       - 'pubspec.yaml'
#       - 'pubspec.lock'
#       - 'android/**'
#       - 'ios/**'

# jobs:
#   run-tests:
#     runs-on: ubuntu-24.04
#     strategy:
#       fail-fast: false
#       matrix:
#         test_file:
#           - simple_test.dart
#           - advanced_test.dart
#           - restart_rounds_test.dart
#           - load_test.dart
#           - interval_adjust_test.dart
#           - edit_timer_test.dart
#           - customize_test.dart
#           - minutes_view_test.dart
#     steps:
#       - name: checkout
#         uses: actions/checkout@v4

#       - uses: subosito/flutter-action@v2
#         with:
#           channel: stable

#       - name: Setup Android SDK
#         uses: android-actions/setup-android@v3

#       - name: Create test script
#         run: |
#           cat <<EOF > scripts/test.sh
#           #!/bin/bash
#           echo "Running test: ${{ matrix.test_file }}"
#           flutter build apk --target integration_test/${{ matrix.test_file }} --debug
#           bash scripts/wait_for_pm.sh
#           adb -s emulator-5554 install build/app/outputs/flutter-apk/app-debug.apk
#           adb -s emulator-5554 shell appops set com.codepup.workout_timer SCHEDULE_EXACT_ALARM allow
#           flutter drive -d emulator-5554 --no-pub \
#             --driver=integration_test/driver.dart \
#             --use-application-binary=build/app/outputs/flutter-apk/app-debug.apk
#           EOF

#           chmod +x scripts/test.sh

#       - name: Enable KVM
#         run: |
#           echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
#           sudo udevadm control --reload-rules
#           sudo udevadm trigger --name-match=kvm

#       - name: Run integration tests
#         uses: reactivecircus/android-emulator-runner@v2
#         with:
#           api-level: 36
#           arch: x86_64
#           force-avd-creation: false
#           emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
#           disable-animations: true
#           script: scripts/test.sh

#       - name: Upload screenshots
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: screenshots-${{ matrix.test_file }}
#           path: screenshots/

