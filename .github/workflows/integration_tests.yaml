name: Build and Run Integration Tests

run-name: ${{ github.actor }} is building and testing OpenHIIT

on:
  workflow_dispatch:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
    branches:
      - 'main'
      - 'pre-release'
    paths:
      - 'lib/**'
      - 'test_driver/**'
      - 'integration_test/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - 'android/**'
      - 'ios/**'

jobs:

  simple-test:
    runs-on: ubuntu-latest
    env:
      ANDROID_EMULATOR_WAIT_TIME_BEFORE_KILL: 180
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Flutter Doctor
        run: flutter doctor -v

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Run simple_test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 35
          arch: x86_64
          profile: pixel_6_pro
          script: |
            flutter build apk --target=integration_test/simple_test.dart --debug
            adb -s emulator-5554 install build/app/outputs/flutter-apk/app-debug.apk
            adb -s emulator-5554 root
            adb -s emulator-5554 shell appops set com.codepup.workout_timer SCHEDULE_EXACT_ALARM allow
            flutter drive -d emulator-5554 --driver=integration_test/driver.dart --use-application-binary=build/app/outputs/flutter-apk/app-debug.apk

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-simple_test
          path: screenshots/

  advanced-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Run advanced_test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 35
          arch: x86_64
          profile: pixel_6_pro
          script: |
            flutter build apk --target=integration_test/advanced_test.dart --debug
            adb -s emulator-5554 install build/app/outputs/flutter-apk/app-debug.apk
            adb -s emulator-5554 root
            adb -s emulator-5554 shell appops set com.codepup.workout_timer SCHEDULE_EXACT_ALARM allow
            flutter drive -d emulator-5554 --driver=integration_test/driver.dart --use-application-binary=build/app/outputs/flutter-apk/app-debug.apk
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-advanced_test
          path: screenshots/

  restart-rounds-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Run restart_rounds_test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 35
          arch: x86_64
          profile: pixel_6_pro
          script: |
            flutter build apk --target=integration_test/restart_rounds_test.dart --debug
            adb -s emulator-5554 install build/app/outputs/flutter-apk/app-debug.apk
            adb -s emulator-5554 root
            adb -s emulator-5554 shell appops set com.codepup.workout_timer SCHEDULE_EXACT_ALARM allow
            flutter drive -d emulator-5554 --driver=integration_test/driver.dart --use-application-binary=build/app/outputs/flutter-apk/app-debug.apk
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-restart_rounds_test
          path: screenshots/

  load-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Run load_test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 35
          arch: x86_64
          profile: pixel_6_pro
          script: |
            flutter build apk --target=integration_test/load_test.dart --debug
            adb -s emulator-5554 install build/app/outputs/flutter-apk/app-debug.apk
            adb -s emulator-5554 root
            adb -s emulator-5554 shell appops set com.codepup.workout_timer SCHEDULE_EXACT_ALARM allow
            flutter drive -d emulator-5554 --driver=integration_test/driver.dart --use-application-binary=build/app/outputs/flutter-apk/app-debug.apk
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-load_test
          path: screenshots/

  interval-adjust-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Run interval_adjust_test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 35
          arch: x86_64
          profile: pixel_6_pro
          script: |
            flutter build apk --target=integration_test/interval_adjust_test.dart --debug
            adb -s emulator-5554 install build/app/outputs/flutter-apk/app-debug.apk
            adb -s emulator-5554 root
            adb -s emulator-5554 shell appops set com.codepup.workout_timer SCHEDULE_EXACT_ALARM allow
            flutter drive -d emulator-5554 --driver=integration_test/driver.dart --use-application-binary=build/app/outputs/flutter-apk/app-debug.apk
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-interval_adjust_test
          path: screenshots/

  edit-timer-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Run edit_timer_test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 35
          arch: x86_64
          profile: pixel_6_pro
          script: |
            flutter build apk --target=integration_test/edit_timer_test.dart --debug
            adb -s emulator-5554 install build/app/outputs/flutter-apk/app-debug.apk
            adb -s emulator-5554 root
            adb -s emulator-5554 shell appops set com.codepup.workout_timer SCHEDULE_EXACT_ALARM allow
            flutter drive -d emulator-5554 --driver=integration_test/driver.dart --use-application-binary=build/app/outputs/flutter-apk/app-debug.apk
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-edit_timer_test
          path: screenshots/

  report:
    runs-on: ubuntu-latest
    needs:
      - simple-test
      - advanced-test
      - restart-rounds-test
      - load-test
      - interval-adjust-test
      - edit-timer-test
    if: always()
    steps:
      - name: Download all screenshots
        uses: actions/download-artifact@v4
        with:
          path: screenshots/

      - name: Generate HTML report
        run: |
          mkdir -p report
          echo "<html><head><title>Integration Test Report</title></head><body>" >> report/report.html
          echo "<h1>Integration Test Screenshots</h1>" >> report/report.html

          for dir in screenshots/*; do
            if [ -d "$dir" ]; then
              echo "<h2>${dir##*/}</h2>" >> report/report.html
              for img in $(find "$dir" -type f \( -iname "*.png" -o -iname "*.jpg" \)); do
                echo "<div><img src='../$img' width='300'><p>$img</p></div>" >> report/report.html
              done
            fi
          done

          echo "</body></html>" >> report/report.html

      - name: Upload combined report
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-report
          path: report/report.html

# name: Build and Run Integration Tests

# run-name: ${{ github.actor }} is building and testing OpenHIIT

# on:
#   workflow_dispatch:
#   pull_request:
#     types:
#       - opened
#       - reopened
#       - synchronize
#       - ready_for_review
#     branches:
#       - 'main'
#       - 'pre-release'
#     paths:
#       - 'lib/**'
#       - 'test_driver/**'
#       - 'integration_test/**'
#       - 'pubspec.yaml'
#       - 'pubspec.lock'
#       - 'android/**'
#       - 'ios/**'

# jobs:

#   integration-tests:
#     runs-on: ubuntu-latest
#     strategy:
#       fail-fast: false
#       matrix:
#         test_file:
#           - simple_test.dart
#           - advanced_test.dart
#           - restart_rounds_test.dart
#           - load_test.dart
#           - interval_adjust_test.dart
#           - edit_timer_test.dart
#     env:
#       ANDROID_EMULATOR_WAIT_TIME_BEFORE_KILL: 180
#     steps:
#       - uses: actions/checkout@v3

#       - name: Set up JDK 17
#         uses: actions/setup-java@v3
#         with:
#           java-version: '17'
#           distribution: 'temurin'

#       - uses: subosito/flutter-action@v2
#         with:
#           channel: 'stable'

#       - name: Check Version
#         run: flutter --version

#       - name: Flutter Doctor
#         run: flutter doctor -v

#       - name: Enable KVM
#         run: |
#           echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
#           sudo udevadm control --reload-rules
#           sudo udevadm trigger --name-match=kvm

#       - name: Setup Android SDK
#         uses: android-actions/setup-android@v3

      
#       - name: run tests
#         uses: reactivecircus/android-emulator-runner@v2
#         env:
#           TEST_FILE: ${{ matrix.test_file }}
#         with:
#           api-level: 35
#           arch: x86_64
#           profile: pixel_6_pro
#           script: |
#             echo "Running test: $TEST_FILE"
#             flutter build apk --target=integration_test/$TEST_FILE --debug
#             adb -s emulator-5554 install build/app/outputs/flutter-apk/app-debug.apk
#             adb -s emulator-5554 root
#             adb -s emulator-5554 shell appops set com.codepup.workout_timer SCHEDULE_EXACT_ALARM allow
#             flutter drive -d emulator-5554 \
#               --driver=integration_test/driver.dart \
#               --use-application-binary=build/app/outputs/flutter-apk/app-debug.apk

#       - name: Upload screenshots
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: screenshots-${{ matrix.test_file }}
#           path: screenshots/

#   report:
#     runs-on: ubuntu-latest
#     needs: integration-tests
#     if: always()
#     steps:
#       - name: Download all screenshots
#         uses: actions/download-artifact@v4
#         with:
#           path: screenshots/

#       - name: Generate HTML report
#         run: |
#           mkdir -p report
#           echo "<html><head><title>Integration Test Report</title></head><body>" >> report/report.html
#           echo "<h1>Integration Test Screenshots</h1>" >> report/report.html

#           for dir in screenshots/*; do
#             if [ -d "$dir" ]; then
#               echo "<h2>${dir##*/}</h2>" >> report/report.html
#               for img in $(find "$dir" -type f \( -iname "*.png" -o -iname "*.jpg" \)); do
#                 echo "<div><img src='../$img' width='300'><p>$img</p></div>" >> report/report.html
#               done
#             fi
#           done

#           echo "</body></html>" >> report/report.html

#       - name: Upload combined report
#         uses: actions/upload-artifact@v4
#         with:
#           name: integration-test-report
#           path: report/report.html


#   # Advanced:
#   #   runs-on: ubuntu-latest
#   #   steps:
#   #     - uses: actions/checkout@v3

#   #     - name: Set up JDK 17
#   #       uses: actions/setup-java@v3
#   #       with:
#   #         java-version: '17'
#   #         distribution: 'temurin'

#   #     - uses: subosito/flutter-action@v2
#   #       with:
#   #         channel: 'stable'
#   #     - name: Check Version
#   #       run: flutter --version

#   #     - name: Flutter Doctor
#   #       run: flutter doctor -v

#   #     - name: Enable KVM
#   #       run: |
#   #         echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
#   #         sudo udevadm control --reload-rules
#   #         sudo udevadm trigger --name-match=kvm

#   #     - name: Setup Android SDK
#   #       uses: android-actions/setup-android@v3
      
#   #     - name: run tests
#   #       uses: reactivecircus/android-emulator-runner@v2
#   #       with:
#   #         api-level: 34
#   #         arch: x86_64
#   #         profile: pixel_6_pro
#   #         disable-animations: true
#   #         ram-size: 3072
#   #         emulator-options: "-no-window -gpu swiftshader_indirect"
#   #         script: |
#   #           flutter build apk --target integration_test/advanced_test.dart --debug
#   #           adb -s emulator-5554 install build/app/outputs/flutter-apk/app-debug.apk
#   #           adb -s emulator-5554 root
#   #           adb -s emulator-5554 shell appops set com.codepup.workout_timer SCHEDULE_EXACT_ALARM allow
#   #           flutter drive -d emulator-5554 --driver=integration_test/driver.dart --use-application-binary=build/app/outputs/flutter-apk/app-debug.apk

#   #     - name: Upload screenshots
#   #       if: always()
#   #       uses: actions/upload-artifact@v4
#   #       with:
#   #         name: android-advanced-screenshots
#   #         path: screenshots/
